<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Monthly Music Schedule</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
      }

      .header-container h1 {
        text-align: center;
      }

      #how-to-use {
        text-align: center;
        margin-top: -20px;
        margin-bottom: 10px;
      }

      #month-selection-container {
        text-align: center;
        margin-bottom: 20px;
      }

      #result {
        text-align: center;
      }

      .large-button {
        width: 200px;
        height: 50px;
      }

      label {
        margin-right: 10px;
      }

      /* Container for the form columns */
      .form-column {
        display: flex;
        flex-direction: column;
        align-items: flex-start;
      }

      .form-column h3 {
        text-align: center;
        width: 100%;
        margin-top: 10px;
      }

      .day-title {
        text-align: center;
        width: 100%;
        margin-top: -15px;
        margin-bottom: 20px;
      }

      /* Each form group (label + input pair) */
      .form-group {
        display: grid;
        grid-template-columns: 120px 1fr;
        align-items: center;
        margin-bottom: 10px;
      }

      /* Style for the labels */
      .form-group label {
        width: 100px;
        text-align: right;
        padding-right: 10px;
      }

      /* Style for the input fields */
      .form-group input[type="text"],
      .form-group input[type="radio"] {
        flex: 1;
        padding: 5px;
        margin-right: 5px;
      }

      /* Ensure that multiple inputs in a form group are aligned */
      .form-group .multiple-inputs {
        flex: 1;
        /* Do not use padding. It makes Gospel Acclamation radio buttons unaligned. */
        margin-right: 5px;
        /* Display flex also unaligns the Gospel Acclamation radio buttons. */
      }

      .multiple-inputs label {
        margin-left: 5px;
        margin-right: 10px;
      }

      .mini-forms-container {
        display: flex;
        justify-content: space-between; /* Evenly distribute columns */
        gap: 20px; /* Gap between columns */
      }

      /* Center the submit button */
      #hymn-form-submit-button {
        margin: 20px auto; /* Center horizontally with top and bottom margin */
        display: block; /* Ensure it's a block element */
      }

      /* CSS for each column */
      .column {
        /* Each column takes up equal space */
        flex: 1;
        /* Padding for content */
        padding: 10px;
        /* Border for clarity */
        border: 1px solid #ccc;
      }

      .hidden {
        display: none;
      }
    </style>
  </head>
  <body>
    <div class="header-container">
      <h1>Monthly Music Schedule</h1>
    </div>
    <div id="how-to-use">
      Please enter Hymn Numbers for hymns in the Gather, and Hymn Names for
      hymns in the Binder.
    </div>
    <div id="month-selection-container">
      <input type="radio" id="this-month" name="schedule-month" checked />
      <label for="this-month">This Month</label>
      <input type="radio" id="next-month" name="schedule-month" />
      <label for="next-month">Next Month</label>
    </div>
    <form id="hymn-form">
      <datalist id="all-hymns-list"></datalist>
      <datalist id="liturgical-day-titles"></datalist>
      <div id="mini-forms-container-0" class="mini-forms-container"></div>
      <div id="mini-forms-container-1" class="mini-forms-container"></div>
      <div id="hymn-form-submit-button-container"></div>
    </form>
    <div id="result"></div>
    <!-- formatDate.js -->
    <script>
      function formatDate(date) {
        const options = {
          weekday: "long",
          year: "numeric",
          month: "long",
          day: "numeric",
        };

        return date.toLocaleDateString("en-CA", options);
      }
    </script>
    <!-- sundaysInAMonth.js -->
    <script>
      /**
       * Get a list of all Sundays in the current month.
       * @returns {Date[]} A list of Dates for each Sunday in the current month.
       */
      function sundaysInAMonth(today) {
        // Get the year and month
        const year = today.getFullYear();
        const month = today.getMonth();
        const endOfCurrentMonth = new Date(year, month + 1, 0).getDate();

        // Initialize list of Sundays
        let sundaysList = [];

        // Loop through each day of the month
        for (let day = 1; day <= endOfCurrentMonth; day++) {
          let currentDate = new Date(year, month, day);
          // Check if the current day is a Sunday (day 0 in JavaScript Date object)
          if (currentDate.getDay() === 0) sundaysList.push(currentDate);
        }

        // Return the list of Sundays found
        return sundaysList;
      }
    </script>
    <!-- Sundays this month and next month + constants for today and the first of next month -->
    <!-- getCurrentMonth.js -->
    <script>
      const today = (function () {
        const today = new Date();
        return today;
      })();

      const firstOfNextMonth = (function () {
        const year = today.getFullYear();
        const month = today.getMonth() + 1;
        const firstOfNextMonth = new Date(year, month, 1);
        return firstOfNextMonth;
      })();

      const sundaysThisMonth = (function () {
        return sundaysInAMonth(today);
      })();

      const sundaysNextMonth = (function () {
        return sundaysInAMonth(firstOfNextMonth);
      })();

      const getCurrentMonth = function () {
        if (nextMonthForms.classList.contains("hidden")) return "thisMonth";
        else if (thisMonthForms.classList.contains("hidden"))
          return "nextMonth";
        return null;
      };

      const sendTheseSundays = function () {
        const month = getCurrentMonth();
        if (month === "thisMonth") return sundaysThisMonth;
        else if (month === "nextMonth") return sundaysNextMonth;
      };

      const numberOfDivs = function () {
        const currentMonth = getCurrentMonth();

        if (currentMonth === "thisMonth") return sundaysThisMonth.length;
        else if (currentMonth === "nextMonth") return sundaysNextMonth.length;
        return null;
      };
    </script>
    <script>
      function getLabelText(inputType) {
        let labelText;
        switch (inputType) {
          case "gathering":
            labelText = "Gathering Hymn";
            break;
          case "psalm":
            labelText = "Psalm";
            break;
          case "offertory":
            labelText = "Offertory Hymn";
            break;
          case "communion":
            labelText = "Communion Hymn";
            break;
          case "recessional":
            labelText = "Recesional Hymn";
            break;
          case "gloria":
            labelText = "Gloria";
            break;
          case "gospel":
            labelText = "Gospel Acclamation";
            break;
          case "sanctus":
            labelText = "Sanctus";
            break;
          case "memorial":
            labelText = "Memorial Acclamation";
            break;
          case "amen":
            labelText = "Amen";
            break;
          case "lamb":
            labelText = "Lamb of God";
            break;
          case "gospel-verse-line1":
            labelText = "Verse: Line 1";
            break;
          case "gospel-verse-line2":
            labelText = "Verse: Line 2";
            break;
          default:
            break;
        }
        return labelText;
      }
    </script>
    <!-- Mini-form input types -->
    <script>
      class FormInput {
        constructor(date) {
          this.date = date;
        }
      }
    </script>
    <!-- Generate Hymn Inputs -->
    <script>
      class HymnInput extends FormInput {
        constructor(date) {
          super(date);
        }

        generate() {
          const date = this.date;
          const month = date.getMonth();
          const day = date.getDate();

          const part = this.hymnType;
          const labelText = getLabelText(part);

          const inputType = "text";

          let element = document.createElement("div");
          element.classList.add("form-group");
          element.innerHTML = `
            <label for="${month}-${part}-${day}">${labelText}</label>
          `;

          element.innerHTML += `
            <input
              type="${inputType}"
              id="${month}-${part}-${day}"
              month=${month}
              day=${day}
              name="${month}-${part}-${day}"
              list="all-hymns-list"
              value=""
              required
            />
          `;
          return element;
        }
      }

      class GatheringInput extends HymnInput {
        constructor(date) {
          super(date);
          this.hymnType = "gathering";
        }
      }

      class PsalmInput extends HymnInput {
        constructor(date) {
          super(date);
          this.hymnType = "psalm";
        }
      }

      class OffertoryInput extends HymnInput {
        constructor(date) {
          super(date);
          this.hymnType = "offertory";
        }
      }

      class CommunionInput extends HymnInput {
        constructor(date) {
          super(date);
          this.hymnType = "communion";
        }
      }

      class RecessionalInput extends HymnInput {
        constructor(date) {
          super(date);
          this.hymnType = "recessional";
        }
      }
    </script>
    <!-- Generate Storrington Checkbox Inputs -->
    <script>
      class StorringtonCheckboxInput extends FormInput {
        constructor(date) {
          super(date);
        }

        generate() {
          const date = this.date;
          const month = date.getMonth();
          const day = date.getDate();

          const part = this.storringtonPart;
          const labelText = getLabelText(part);

          const type = "checkbox";

          let element = document.createElement("div");
          element.classList.add("form-group");
          element.innerHTML = `
            <label for="${month}-${part}-${day}">${labelText}</label>
          `;

          element.innerHTML += `
            <input
              type="${type}"
              id="${month}-${part}-${day}"
              month=${month}
              day=${day}
              name="${month}-${part}-${day}"
              value="true"
              checked
            />
          `;
          return element;
        }
      }

      class GloriaInput extends StorringtonCheckboxInput {
        constructor(date) {
          super(date);
          this.storringtonPart = "gloria";
        }
      }

      class SanctusInput extends StorringtonCheckboxInput {
        constructor(date) {
          super(date);
          this.storringtonPart = "sanctus";
        }
      }

      class AmenInput extends StorringtonCheckboxInput {
        constructor(date) {
          super(date);
          this.storringtonPart = "amen";
        }
      }

      class LambOfGodInput extends StorringtonCheckboxInput {
        constructor(date) {
          super(date);
          this.storringtonPart = "lamb";
        }
      }
    </script>
    <!-- Generate Storrington Radio Inputs -->
    <script>
      class GospelAcclamationInput extends FormInput {
        constructor(date) {
          super(date);
          this.storringtonPart = "gospel";
        }

        generate() {
          const date = this.date;
          const month = date.getMonth();
          const day = date.getDate();

          const part = this.storringtonPart;
          const labelText = getLabelText(part);

          const type = "radio";

          const gospel0Label = "None";
          const gospel1Label = "Normal";
          const gospel2Label = "Lenten";

          let element = document.createElement("div");
          element.classList.add("form-group");
          element.innerHTML = `
            <label for="${month}-${part}-${day}">${labelText}</label>
          `;

          element.innerHTML += `
            <div class="multiple-inputs">
              <div class="labelled-radio">
                <input
                  type="${type}"
                  id="${month}-${part}-none-${day}"
                  month=${month}
                  day=${day}
                  name="${month}-${part}-${day}"
                  value="0"
                />
                <label for="${month}-${part}-none-${day}">${gospel0Label}</label>
              </div>
              <div class="labelled-radio">
                <input
                  type="${type}"
                  id="${month}-${part}-norm-${day}"
                  month=${month}
                  day=${day}
                  name="${month}-${part}-${day}"
                  value="1"
                  checked
                />
                <label for="${month}-${part}-norm-${day}">${gospel1Label}</label>
              </div>
              <div class="labelled-radio">
                <input
                  type="${type}"
                  id="${month}-${part}-lent-${day}"
                  month=${month}
                  day=${day}
                  name="${month}-${part}-${day}"
                  value="2"
                />
                <label for="${month}-${part}-lent-${day}">${gospel2Label}</label>
              </div>
            </div>
          `;
          return element;
        }
      }
    </script>
    <script>
      class MemorialInput extends FormInput {
        constructor(date) {
          super(date);
          this.storringtonPart = "memorial";
        }

        generate() {
          const date = this.date;
          const month = date.getMonth();
          const day = date.getDate();

          const part = this.storringtonPart;
          const labelText = getLabelText(part);

          const type = "radio";

          const memorial0Label = "None";
          const memorial1Label = "When We Eat...";
          const memorial2Label = "We Proclaim...";
          const memorial3Label = "Save Us...";

          let element = document.createElement("div");
          element.classList.add("form-group");
          element.innerHTML = `
            <label for="${month}-${part}-${day}">${labelText}</label>
          `;

          element.innerHTML += `
            <div class="multiple-inputs">
              <div class="labelled-radio">
                <input
                  type="${type}"
                  id="${month}-${part}0-${day}"
                  month=${month}
                  day=${day}
                  name="${month}-${part}-${day}"
                  value="0"
                />
                <label for="${month}-${part}0-${day}">${memorial0Label}</label>
              </div>
              <div class="labelled-radio">
                <input
                  type="${type}"
                  id="${month}-${part}1-${day}"
                  month=${month}
                  day=${day}
                  name="${month}-${part}-${day}"
                  value="1"
                  checked
                />
                <label for="${month}-${part}1-${day}">${memorial1Label}</label>
              </div>
              <div class="labelled-radio">
                <input
                  type="${type}"
                  id="${month}-${part}2-${day}"
                  month=${month}
                  day=${day}
                  name="${month}-${part}-${day}"
                  value="2"
                />
                <label for="${month}-${part}2-${day}">${memorial2Label}</label>
              </div>
              <div class="labelled-radio">
                <input
                  type="${type}"
                  id="${month}-${part}3-${day}"
                  month=${month}
                  day=${day}
                  name="${month}-${part}-${day}"
                  value="3"
                />
                <label for="${month}-${part}3-${day}">${memorial3Label}</label>
              </div>
            </div>
          `;
          return element;
        }
      }
    </script>
    <!-- Generate Verse Line Inputs -->
    <script>
      class GospelVerseLineInput extends FormInput {
        constructor(date, lineNumber) {
          super(date);
          this.storringtonPart = "gospel-verse-line" + lineNumber;
        }

        generate() {
          const date = this.date;
          const month = date.getMonth();
          const day = date.getDate();

          const part = this.storringtonPart;
          const labelText = getLabelText(part);

          const inputType = "text";

          let element = document.createElement("div");
          element.classList.add("form-group");
          element.innerHTML = `
            <label for="${month}-${part}-${day}">${labelText}</label>
          `;

          element.innerHTML += `
            <input
              type="${inputType}"
              id="${month}-${part}-${day}"
              month=${month}
              day=${day}
              name="${month}-${part}-${day}"
              value=""
              required
            />
          `;
          return element;
        }
      }
    </script>
    <!-- generateMiniForm.js -->
    <script>
      class MiniForm {
        constructor(date) {
          this.date = date;
        }

        generate() {
          const date = this.date;
          const month = date.getMonth();
          const day = date.getDate();
          const miniFormClass = "mini-form";

          let element = document.createElement("div");

          element.id = `${month}-form-column-${day}`;
          // Apply form column CSS
          element.classList.add("column", "form-column");
          element.setAttribute("month", month);
          element.setAttribute("day", day);

          element.innerHTML = `
            <h3>${formatDate(date)}</h3>
            <div class="day-title">
            <input
              type="text"
              id="${month}-day-title-${day}"
              class=${miniFormClass}
              month=${month}
              day=${day}
              name="${month}-day-title-${day}"
              list="liturgical-day-titles"
              style="font-weight: bold; height: 20px; font-size: 12pt; text-align: center;"
            />
            </div>
          `;

          const gathering = new GatheringInput(date).generate();
          const gloria = new GloriaInput(date).generate();
          const psalm = new PsalmInput(date).generate();
          const gospel = new GospelAcclamationInput(date).generate();
          const gospelLine1 = new GospelVerseLineInput(date, 1).generate();
          const gospelLine2 = new GospelVerseLineInput(date, 2).generate();
          const offertory = new OffertoryInput(date).generate();
          const sanctus = new SanctusInput(date).generate();
          const memorial = new MemorialInput(date).generate();
          const amen = new AmenInput(date).generate();
          const lamb = new LambOfGodInput(date).generate();
          const communion = new CommunionInput(date).generate();
          const recessional = new RecessionalInput(date).generate();

          // Add all parts to the mini form
          element.append(
            gathering,
            gloria,
            psalm,
            gospel,
            gospelLine1,
            gospelLine2,
            offertory,
            sanctus,
            memorial,
            amen,
            lamb,
            communion,
            recessional
          );

          return element;
        }
      }

      function generateMiniForm(date) {
        const currentMonth = date.getMonth();
        const i = date.getDate();

        let month = 0;
        // currently generating a mini-form for next month
        if (currentMonth !== new Date().getMonth()) month = 1;

        let element = document.createElement("div");

        element.id = `${currentMonth}-form-column-${i}`;
        // Apply form column CSS
        element.classList.add("column", "form-column");

        element.innerHTML = `
            <h3>${formatDate(date)}</h3>
            <div class="day-title">
            <input
              type="text"
              id="${currentMonth}-day-title-${i}"
              class="${currentMonth}"
              name="${currentMonth}-day-title-${i}"
              list="liturgical-day-titles"
              style="font-weight: bold; height: 20px; font-size: 12pt; text-align: center;"
            />
            </div>
          `;

        const gathering = new GatheringInput(date).generate();
        const gloria = new GloriaInput(date).generate();
        const psalm = new PsalmInput(date).generate();
        const gospel = new GospelAcclamationInput(date).generate();
        const gospelLine1 = new GospelVerseLineInput(date, 1).generate();
        const gospelLine2 = new GospelVerseLineInput(date, 2).generate();
        const offertory = new OffertoryInput(date).generate();
        const sanctus = new SanctusInput(date).generate();
        const memorial = new MemorialInput(date).generate();
        const amen = new AmenInput(date).generate();
        const lamb = new LambOfGodInput(date).generate();
        const communion = new CommunionInput(date).generate();
        const recessional = new RecessionalInput(date).generate();

        // Add all parts to the mini form
        element.append(
          gathering,
          gloria,
          psalm,
          gospel,
          gospelLine1,
          gospelLine2,
          offertory,
          sanctus,
          memorial,
          amen,
          lamb,
          communion,
          recessional
        );

        document
          .getElementById(`mini-forms-container-${month}`)
          .append(element);
      }
    </script>
    <!-- addSubmitButton -->
    <script>
      let addSubmitButton = (function () {
        let submitButton = document.createElement("button");
        submitButton.classList.add("large-button");
        submitButton.setAttribute("type", "submit");
        submitButton.setAttribute("id", "hymn-form-submit-button");
        submitButton.setAttribute("name", "submit");
        submitButton.textContent = "Submit";
        document
          .getElementById("hymn-form-submit-button-container")
          .append(submitButton);
      })();
    </script>

    <!-- hymnsDatalist.js -->
    <script>
      let hymnsDatalistFragment = new DocumentFragment();
      google.script.run
        .withSuccessHandler((response) => {
          // Populate the fragment with options from the response list which contains all hymn titles
          response.forEach((element) => {
            let option = document.createElement("option");
            option.value = element;
            hymnsDatalistFragment.appendChild(option);
          });

          // Append the fragment to the datalist
          document
            .getElementById("all-hymns-list")
            .appendChild(hymnsDatalistFragment);
        })
        .getHymnOptions();
    </script>

    <!-- liturgicalDayTitlesDatalist.js -->
    <script>
      let liturgicalDayTitlesFragment = new DocumentFragment();
      google.script.run
        .withSuccessHandler((response) => {
          // Populate the fragment with options from the response list which contains all hymn titles
          response.forEach((element) => {
            let option = document.createElement("option");
            option.value = element;
            liturgicalDayTitlesFragment.appendChild(option);
          });

          // Append the fragment to the datalist
          document
            .getElementById("liturgical-day-titles")
            .appendChild(liturgicalDayTitlesFragment);
        })
        .getLiturgicalDayTitles();
    </script>

    <!-- index.js -->
    <script>
      let index = (function () {
        "use strict";
        sundaysNextMonth.map(generateMiniForm);
        sundaysThisMonth.map(generateMiniForm);
      })();
    </script>

    <!-- getHymnsOfType.js -->
    <script>
      let getHymnsOfType = function (type) {
        const hymnTypeList = [];

        for (let i = 0; i < numberOfDivs(); i++) {
          hymnTypeList.push(
            document.querySelector(
              `#${getCurrentMonth()}-${type}-${i}.${getCurrentMonth()}`
            ).value
          );
        }

        return hymnTypeList;
      };
    </script>
    <!-- getGospelVerses.js -->
    <script>
      let getGospelVerses = function () {
        const gospelVerses = [];

        for (let i = 0; i < numberOfDivs(); i++) {
          gospelVerses.push({
            line1: document.querySelector(
              `#${getCurrentMonth()}-gospel-line1-${i}.${getCurrentMonth()}`
            ).value,
            line2: document.querySelector(
              `#${getCurrentMonth()}-gospel-line2-${i}.${getCurrentMonth()}`
            ).value,
          });
        }

        return gospelVerses;
      };
    </script>
    <!-- compileLiturgicalDayTitles.js -->
    <script>
      let compileLiturgicalDayTitles = function () {
        const liturgicalDayTitles = [];

        for (let i = 0; i < numberOfDivs(); i++) {
          liturgicalDayTitles.push(
            document.querySelector(
              `#${getCurrentMonth()}-day-title-${i}.${getCurrentMonth()}`
            ).value
          );
        }

        return liturgicalDayTitles;
      };
    </script>
    <!-- submitForm.js -->
    <script>
      document
        .getElementById("hymn-form")
        .addEventListener("submit", function (event) {
          event.preventDefault();

          const hymnTypes = [
            "gathering",
            "psalm",
            "offertory",
            "communion",
            "recessional",
          ];

          // Add all the hymns to be processed
          const [gatherings, psalms, offertories, communions, recessionals] =
            hymnTypes.map(getHymnsOfType);

          // Add the Gospel verse lines to be processed
          const gospelVerses = getGospelVerses();

          // Add all the checkboxes and selected radios to be processed
          const storringtonParts = [];
          document
            .querySelectorAll(`input:checked.${getCurrentMonth()}`)
            .forEach((input) =>
              storringtonParts.push({
                name: input.name,
                value: input.value,
              })
            );

          const liturgicalDayTitles = compileLiturgicalDayTitles();

          // Send to backend
          google.script.run
            .withSuccessHandler((response) => {
              document.getElementById("result").innerHTML = `
                <a href="${response}" target="_blank" rel="noopener noreferrer">
                  Google Docs - Music Schedule
                </a>
              `;
            })
            .processForm(
              sendTheseSundays(),
              gatherings,
              psalms,
              offertories,
              communions,
              recessionals,
              gospelVerses,
              storringtonParts,
              liturgicalDayTitles
            );
        });
    </script>
    <!-- swapToForm.js -->
    <script>
      const thisMonthForms = document.getElementById("mini-forms-container-0");
      const nextMonthForms = document.getElementById("mini-forms-container-1");

      const thisMonthInputs = document.querySelectorAll(".thisMonth");
      const nextMonthInputs = document.querySelectorAll(".nextMonth");

      nextMonthForms.classList.add("hidden");
      nextMonthInputs.forEach((input) => {
        input.required = false;
      });

      const swapToForm = function (month) {
        if (month === 0) {
          thisMonthForms.classList.remove("hidden");
          nextMonthForms.classList.add("hidden");

          thisMonthInputs.forEach((input) => {
            input.required = true;
          });
          nextMonthInputs.forEach((input) => {
            input.required = false;
          });
        } else if (month === 1) {
          thisMonthForms.classList.add("hidden");
          nextMonthForms.classList.remove("hidden");

          nextMonthInputs.forEach((input) => {
            input.required = true;
          });
          thisMonthInputs.forEach((input) => {
            input.required = false;
          });
        }
      };

      document
        .getElementById("this-month")
        .addEventListener("click", function (e) {
          swapToForm(0);
        });
      document
        .getElementById("next-month")
        .addEventListener("click", function (e) {
          swapToForm(1);
        });
    </script>
  </body>
</html>
