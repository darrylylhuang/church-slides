<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Monthly Music Schedule</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
      }

      .header-container h1 {
        text-align: center;
      }

      #how-to-use {
        text-align: center;
        margin-top: -20px;
        margin-bottom: 10px;
      }

      #month-selection-container {
        text-align: center;
        margin-bottom: 20px;
      }

      .large-button {
        width: 200px;
        height: 50px;
      }

      .form-group {
        margin-bottom: 15px;
      }

      label {
        margin-right: 10px;
      }

      /* Container for the form columns */
      .form-column {
        display: flex;
        flex-direction: column;
        align-items: flex-start;
      }

      .form-column h3 {
        text-align: center;
        width: 100%;
        margin-top: 10px;
        margin-bottom: 10px;
      }

      /* Each form group (label + input pair) */
      .form-group {
        display: grid;
        grid-template-columns: 120px 1fr;
        align-items: center;
        margin-bottom: 10px;
      }

      /* Style for the labels */
      .form-group label {
        width: 100px;
        text-align: right;
        padding-right: 10px;
      }

      /* Style for the input fields */
      .form-group input[type="text"],
      .form-group input[type="radio"] {
        flex: 1;
        padding: 5px;
        margin-right: 5px;
      }

      /* Ensure that multiple inputs in a form group are aligned */
      .form-group .multiple-inputs {
        flex: 1;
        /* Do not use padding. It makes Gospel Acclamation radio buttons unaligned. */
        margin-right: 5px;
        /* Display flex also unaligns the Gospel Acclamation radio buttons. */
      }

      .multiple-inputs label {
        margin-left: 5px;
        margin-right: 10px;
      }

      .mini-forms-container {
        display: flex;
        justify-content: space-between; /* Evenly distribute columns */
        gap: 20px; /* Gap between columns */
      }

      /* Center the submit button */
      #hymn-form-submit-button {
        margin: 20px auto; /* Center horizontally with top and bottom margin */
        display: block; /* Ensure it's a block element */
      }

      /* CSS for each column */
      .column {
        flex: 1; /* Each column takes up equal space */
        padding: 10px; /* Padding for content */
        border: 1px solid #ccc; /* Border for clarity */
      }

      .hidden {
        display: none;
      }
    </style>
  </head>
  <body>
    <div class="header-container">
      <h1>Monthly Music Schedule</h1>
    </div>
    <div id="how-to-use">
      Please enter Hymn Numbers for hymns in the Gather, and Hymn Names for
      hymns in the Binder.
    </div>
    <div id="month-selection-container">
      <input type="radio" id="this-month" name="schedule-month" checked />
      <label for="this-month">This Month</label>
      <input type="radio" id="next-month" name="schedule-month" />
      <label for="next-month">Next Month</label>
    </div>
    <form id="hymn-form">
      <div id="mini-forms-container-0" class="mini-forms-container"></div>
      <div id="mini-forms-container-1" class="mini-forms-container"></div>
      <div id="hymn-form-submit-button-container"></div>
    </form>
    <div id="result"></div>
    <!-- sundaysInAMonth.js -->
    <script>
      /**
       * Get a list of all Sundays in the current month formatted as strings.
       * @returns {string[]} A list of formatted date strings for each Sunday in the current month.
       */
      const sundaysInAMonth = (today) => {
        // Get the year and month
        const year = today.getFullYear();
        const month = today.getMonth();

        // Initialize list of Sundays
        let sundaysList = [];

        let options = {
          weekday: "long",
          year: "numeric",
          month: "long",
          day: "numeric",
        };

        // Loop through each day of the month
        for (
          let day = 1;
          day <= new Date(year, month + 1, 0).getDate();
          day++
        ) {
          let currentDate = new Date(year, month, day);
          // Check if the current day is a Sunday (day 0 in JavaScript Date object)
          if (currentDate.getDay() === 0) {
            sundaysList.push(currentDate.toLocaleDateString("en-CA", options));
          }
        }

        // Return the list of Sundays found
        return sundaysList;
      };
    </script>
    <!-- Sundays this month and next month + constants for today and the first of next month -->
    <script>
      const today = (function () {
        const today = new Date();
        return today;
      })();

      const firstOfNextMonth = (function () {
        const year = today.getFullYear();
        const month = today.getMonth();
        const nextMonth = (month + 1) % 12;
        const firstOfNextMonth = new Date(year, nextMonth, 1);
        return firstOfNextMonth;
      })();

      const sundaysThisMonth = (function () {
        return sundaysInAMonth(today);
      })();

      const sundaysNextMonth = (function () {
        return sundaysInAMonth(firstOfNextMonth);
      })();

      const getCurrentMonth = function () {
        if (nextMonthForms.classList.contains("hidden")) return "thisMonth";
        else if (thisMonthForms.classList.contains("hidden"))
          return "nextMonth";
        return null;
      };

      const numberOfDivs = function () {
        const currentMonth = getCurrentMonth();

        if (currentMonth === "thisMonth") return sundaysThisMonth.length;
        else if (currentMonth === "nextMonth") return sundaysNextMonth.length;
        return null;
      };
    </script>
    <!-- Month names for this month and next month -->
    <script>
      const thisMonth = (function () {
        const thisMonth = today.toLocaleString("en-CA", { month: "long" });
        return thisMonth;
      })();

      const nextMonth = (function () {
        const nextMonth = firstOfNextMonth.toLocaleString("en-CA", {
          month: "long",
        });
        return nextMonth;
      })();
    </script>
    <!-- generateMiniForm.js -->
    <script>
      let generateMiniForm = function (i, month) {
        let sundays = sundaysThisMonth;
        let currentMonth = "thisMonth";
        if (month === 1) {
          sundays = sundaysNextMonth;
          currentMonth = "nextMonth";
        }
        let sunday = sundays[i];
        let element = document.createElement("div");
        element.innerHTML = `
          <div id="form-column-${i}" class="form-column">
            <h3>${sunday}</h3>
            <div class="form-group">
              <label for="gathering-${i}">Gathering Hymn</label>
              <input
                type="text"
                id="gathering-${i}"
                class="${currentMonth}"
                name="gathering-${i}"
                required
              />
            </div>
            <div class="form-group">
              <label>Gloria</label>
              <div class="labelled-checkbox">
                <input
                  type="checkbox"
                  id="gloria-${i}"
                  class="${currentMonth}"
                  name="gloria-${i}"
                  value="true"
                  checked
                />
              </div>
            </div>
            <div class="form-group">
              <label for="psalm-${i}">Psalm</label>
              <input
                type="text"
                id="psalm-${i}"
                class="${currentMonth}"
                name="psalm-${i}"
                required
              />
            </div>
            <div class="form-group">
              <label for="gospel-${i}">Gospel Acclamation</label>
              <div class="multiple-inputs">
                <div class="labelled-radio">
                  <input
                    type="radio"
                    id="gospel-none-${i}"
                    class="${currentMonth}"
                    name="gospel-${i}"
                    value="none"
                  />
                  <label for="gospel-none-${i}">None</label>
                </div>
                <div class="labelled-radio">
                  <input
                    type="radio"
                    id="gospel-norm-${i}"
                    class="${currentMonth}"
                    name="gospel-${i}"
                    value="normal"
                    checked
                  />
                  <label for="gospel-norm-${i}">Normal</label>
                </div>
                <div class="labelled-radio">
                  <input
                    type="radio"
                    id="gospel-lent-${i}"
                    class="${currentMonth}"
                    name="gospel-${i}"
                    value="lenten"
                  />
                  <label for="gospel-lent-${i}">Lenten</label>
                </div>
              </div>
            </div>
            <div class="form-group">
              <label for="gospel-line1-${i}">Verse: Line 1</label>
              <input
                type="text"
                id="gospel-line1-${i}"
                class="${currentMonth}"
                name="gospel-line1-${i}"
                required
              />
            </div>
            <div class="form-group">
              <label for="gospel-line2-${i}">Verse: Line 2</label>
              <input
                type="text"
                id="gospel-line2-${i}"
                class="${currentMonth}"
                name="gospel-line2-${i}"
                required
              />
            </div>
            <div class="form-group">
              <label for="offertory-${i}">Offertory Hymn</label>
              <input
                type="text"
                id="offertory-${i}"
                class="${currentMonth}"
                name="offertory-${i}"
                required
              />
            </div>
            <div class="form-group">
              <label for="memorial-${i}">Memorial Acclamation</label>
              <div class="multiple-inputs">
                <div class="labelled-radio">
                  <input
                    type="radio"
                    id="memorial0-${i}"
                    class="${currentMonth}"
                    name="memorial-${i}"
                    value="0"
                  />
                  <label for="memorial0-${i}">None</label>
                </div>
                <div class="labelled-radio">
                  <input
                    type="radio"
                    id="memorial1-${i}"
                    class="${currentMonth}"
                    name="memorial-${i}"
                    value="1"
                    checked
                  />
                  <label for="memorial1-${i}">When We Eat...</label>
                </div>
                <div class="labelled-radio">
                  <input
                    type="radio"
                    id="memorial2-${i}"
                    class="${currentMonth}"
                    name="memorial-${i}"
                    value="2"
                  />
                  <label for="memorial2-${i}">We Proclaim...</label>
                </div>
                <div class="labelled-radio">
                  <input
                    type="radio"
                    id="memorial3-${i}"
                    class="${currentMonth}"
                    name="memorial-${i}"
                    value="3"
                  />
                  <label for="memorial3-${i}">Save Us...</label>
                </div>
              </div>
            </div>
            <div class="form-group">
              <label>Amen</label>
              <div class="labelled-checkbox">
                <input
                  type="checkbox"
                  id="amen-${i}"
                  class="${currentMonth}"
                  name="amen-${i}"
                  value="true"
                  checked
                />
              </div>
            </div>
            <div class="form-group">
              <label>Lamb of God</label>
              <div class="labelled-checkbox">
                <input
                  type="checkbox"
                  id="lamb-${i}"
                  class="${currentMonth}"
                  name="lamb-${i}"
                  value="true"
                  checked
                />
              </div>
            </div>
            <div class="form-group">
              <label for="communion-${i}">Communion Hymn</label>
              <input
                type="text"
                id="communion-${i}"
                class="${currentMonth}"
                name="communion-${i}"
                required
              />
            </div>
            <div class="form-group">
              <label for="recessional-${i}">Recessional Hymn</label>
              <input
                type="text"
                id="recessional-${i}"
                class="${currentMonth}"
                name="recessional-${i}"
                required
              />
            </div>
          </div>
          `;
        element.classList.add("column");
        document
          .getElementById(`mini-forms-container-${month}`)
          .append(element);
      };
    </script>
    <!-- addSubmitButton -->
    <script>
      let addSubmitButton = (function () {
        let submitButton = document.createElement("button");
        submitButton.classList.add("large-button");
        submitButton.setAttribute("type", "submit");
        submitButton.setAttribute("id", "hymn-form-submit-button");
        submitButton.setAttribute("name", "submit");
        submitButton.textContent = "Submit";
        document
          .getElementById("hymn-form-submit-button-container")
          .append(submitButton);
      })();
    </script>
    <!-- index.js -->
    <script>
      let index = (function () {
        "use strict";

        const numberOfDivs1 = sundaysNextMonth.length;
        for (let i = 0; i < numberOfDivs1; i++) {
          generateMiniForm(i, 1);
        }

        const numberOfDivs0 = sundaysThisMonth.length;
        for (let i = 0; i < numberOfDivs0; i++) {
          generateMiniForm(i, 0);
        }
      })();
    </script>

    <!-- getHymnsOfType.js -->
    <script>
      let getHymnsOfType = function (type) {
        const hymnTypeList = [];

        for (let i = 0; i < numberOfDivs(); i++) {
          hymnTypeList.push(
            document.querySelector(`#${type}-${i}.${getCurrentMonth()}`).value
          );
        }

        return hymnTypeList;
      };
    </script>
    <script>
      let getGospelVerses = function () {
        const gospelVerses = [];

        for (let i = 0; i < numberOfDivs(); i++) {
          gospelVerses.push({
            line1: document.querySelector(
              `#gospel-line1-${i}.${getCurrentMonth()}`
            ).value,
            line2: document.querySelector(
              `#gospel-line2-${i}.${getCurrentMonth()}`
            ).value,
          });
        }

        return gospelVerses;
      };
    </script>
    <!-- submitForm.js -->
    <script>
      document
        .getElementById("hymn-form")
        .addEventListener("submit", function (event) {
          event.preventDefault();

          const hymnTypes = [
            "gathering",
            "psalm",
            "offertory",
            "communion",
            "recessional",
          ];

          // Add all the hymns to be processed
          const [gatherings, psalms, offertories, communions, recessionals] =
            hymnTypes.map(getHymnsOfType);

          // Add the Gospel verse lines to be processed
          const gospelVerses = getGospelVerses();

          // Add all the checkboxes and selected radios to be processed
          const storringtonParts = [];

          document
            .querySelectorAll(`input:checked.${getCurrentMonth()}`)
            .forEach((input) =>
              storringtonParts.push({
                name: input.name,
                value: input.value,
              })
            );

          // Send to backend
          google.script.run
            .withSuccessHandler((response) => {
              document.getElementById("result").innerText = response;
            })
            .processForm(
              sundaysThisMonth,
              gatherings,
              psalms,
              offertories,
              communions,
              recessionals,
              gospelVerses,
              storringtonParts
            );
        });
    </script>
    <!-- swapToForm.js -->
    <script>
      let thisMonthForms = document.getElementById("mini-forms-container-0");
      let nextMonthForms = document.getElementById("mini-forms-container-1");

      let thisMonthInputs = document.querySelectorAll(".thisMonth");
      let nextMonthInputs = document.querySelectorAll(".nextMonth");

      nextMonthForms.classList.add("hidden");
      nextMonthInputs.forEach((input) => {
        input.required = false;
      });

      const swapToForm = function (month) {
        if (month === 0) {
          thisMonthForms.classList.remove("hidden");
          nextMonthForms.classList.add("hidden");

          thisMonthInputs.forEach((input) => {
            input.required = true;
          });
          nextMonthInputs.forEach((input) => {
            input.required = false;
          });
        } else if (month === 1) {
          thisMonthForms.classList.add("hidden");
          nextMonthForms.classList.remove("hidden");

          nextMonthInputs.forEach((input) => {
            input.required = true;
          });
          thisMonthInputs.forEach((input) => {
            input.required = false;
          });
        }
      };

      document
        .getElementById("this-month")
        .addEventListener("click", function (e) {
          swapToForm(0);
        });
      document
        .getElementById("next-month")
        .addEventListener("click", function (e) {
          swapToForm(1);
        });
    </script>
  </body>
</html>
